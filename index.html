<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script>
        async function generateKey() {
            let keys = await window.crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
                    hash: {name: "SHA-256"},
                },
                true,
                ["encrypt", "decrypt"]
            );

            let exportedPublicKey = await window.crypto.subtle.exportKey("jwk", keys.publicKey);
            let exportedPrivateKey = await window.crypto.subtle.exportKey("jwk", keys.privateKey);

            return {
                keys: keys,
                exportedPublicKey: exportedPublicKey,
                exportedPrivateKey: exportedPrivateKey,
                encryptionKey: btoa(JSON.stringify(exportedPublicKey)),
            };
        }

        function displayEncryptionKey(key) {
            console.log(key);
            document.getElementById("public-key").innerText = key
        }


        function getMessageEncoding() {
            let message = "test";
            let enc = new TextEncoder();
            return enc.encode(message);
        }

        function str2ab(str) {
            var buf = new ArrayBuffer(str.length); // 2 bytes for each char
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=str.length; i<strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        async function testIt() {
            let keys = await window.crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
                    hash: {name: "SHA-256"},
                },
                true,
                ["encrypt", "decrypt"]
            )

            let publicK = await window.crypto.subtle.exportKey("jwk", keys.publicKey);
            console.log(btoa(JSON.stringify(publicK)));

            let privateK = await window.crypto.subtle.exportKey("jwk", keys.privateKey);
            // console.log(privateK);

            let encryptedData = getMessageEncoding();
            console.log(encryptedData);

            // Encrypt test
            let chipertext = await window.crypto.subtle.encrypt({name: "RSA-OAEP"}, keys.publicKey, encryptedData)

            console.log(chipertext);
            let chipertextStr = String.fromCharCode.apply(null, new Uint8Array(chipertext));
            console.log(chipertextStr);
            let data = btoa(chipertextStr);
            console.log(data);

            // Decrypt test
            let newChipertextStr = atob(data);
            console.log(newChipertextStr);
            cdata = str2ab(newChipertextStr);
            console.log(cdata);
            let decryptedAb = await window.crypto.subtle.decrypt({name: "RSA-OAEP"}, keys.privateKey, cdata)
            console.log(decryptedAb);
            let decrypted = String.fromCharCode.apply(null, new Uint8Array(decryptedAb));
            console.log(decrypted)
        }

        // testIt();

        async function main() {
            let keys = await generateKey();

            displayEncryptionKey(keys.encryptionKey);
        }

        main();
    </script>
</head>
<body>
    <h1>Crypter</h1>

    <h3>Encrypt</h3>
    <form>
        <label for="encryption_key">Encryption Key: </label>
        <input type="text" id="encryption_key" name="encryption_key"><br><br>
        <label for="plaintext">Plaintext:</label>
        <input type="text" id="plaintext" name="plaintext"><br><br>
        <input type="submit" value="Encrypt">
    </form>

    <h3>Decrypt</h3>
    <p id="public-key"></p>
    <form>
        <label for="chipertext">Chipertext:</label>
        <input type="text" id="chipertext" name="chipertext"><br><br>
        <input type="submit" value="Decrypt">
    </form>
</body>
</html>